
podTemplate(
  cloud: 'kubernetes',
  containers: [
    containerTemplate(
      name: 'anthos',
      image: 'thilavanh/centos-kubectl',
      ttyEnabled: true,
      envVars: [
        envVar(key: "PROJECT_ID", value: "ignw-anthos-lab-pod1a"),
        envVar(key: "CLUSTER_NAME", value: "megatron"),
        envVar(key: "LOCATION", value: "us-west1-b"),
        envVar(key: "NAMESPACE", value: "hipster"),
        secretEnvVar(key: "SVC_ACC_KEY", secretName: "svc_acc_key", secretKey: "svc_acc_key")
      ])]
)

{
  node(POD_LABEL) {
    stage('Deploy to GKE') {
      container('anthos') {
        stage('Installing Hybrid Hipster Demo App') {
          git (url: 'https://github.com/phoukeo/demo-hipster.git', credentialsId: 'phoukeo-github')
            {  step([$class: 'KubernetesEngineBuilder',
              projectId: ${env.PROJECT_ID},
              namespace: ${env.NAMESPACE},
              clusterName: ${env.CLUSTER_NAME},
              location: ${env.LOCATION},
              manifestPattern: 'hipster-all-deploy/deployments.yaml',
              credentialsId: ${env.SVC_ACC_KEY},
              verifyDeployments: false])
            }
          }
    }
  }
}
}
